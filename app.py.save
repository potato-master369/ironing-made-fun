from flask import Flask, render_template, request, redirect, url_for, flash
from flask_sqlalchemy import SQLAlchemy
from flask_login import LoginManager, UserMixin, login_user, logout_user, login_required, current_user
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime
import logging

UPLOAD_FOLDER = os.path.join(os.getcwd(), 'uploads')
os.makedirs(pictures, exist_ok=True)

app.config['UPLOAD_FOLDER'] = pictures
logging.basicConfig(
    filename='app.log',             # Log file name
    level=logging.INFO,             # Log level
    format='%(asctime)s - %(levelname)s - %(message)s'
)

app = Flask(__name__)
app.config['SECRET_KEY'] = 'hya3paupcj3nwb73vqbort7taa3ede6e'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///users.db'

db = SQLAlchemy(app)

#class defns
class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(150), unique=True, nullable=False)
    password = db.Column(db.String(150), nullable=False)
    points = db.Column(db.Integer, default=0)
    role = db.Column(db.String(20), default="user")

class Message(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    author = db.Column(db.String(80))
    content = db.Column(db.Text)
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)

#stupid stuff to make login shutup
login_manager = LoginManager(app)
login_manager.login_view = 'login'

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))

@app.route("/")
def home():
    return render_template("index.html")

@app.route("/about")
def about():
    return render_template("about.html")


@app.route("/rewards")
def poc_v1():
    return render_template("rewards.html")

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        hashed_pw = generate_password_hash(request.form['password'])
        new_user = User(username=request.form['username'], password=hashed_pw)
        db.session.add(new_user)
        db.session.commit()
        return redirect(url_for('login'))
    return render_template('register.html')


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        user = User.query.filter_by(username=request.form['username']).first()
        if user and check_password_hash(user.password, request.form['password']):
            login_user(user)
            return redirect(url_for('home'))
    return render_template('login.html')

@app.route("/forum", methods=["GET", "POST"])
@login_required
def forum():
    if request.method == "POST":
        new_msg = Message(author=current_user.username, content=request.form["content"])
        db.session.add(new_msg)
        db.session.commit()
        return redirect("/forum")

    messages = Message.query.order_by(Message.timestamp.asc()).all()
    return render_template("forum.html", messages=messages)

@app.route("/submit")
@login_required
def submit():
    uploaded_files = request.files.getlist('files[]')
    saved_files = []

    for file in uploaded_files:
        if file.filename == '':
            continue  # skip empty fields

        filepath = os.path.join(app.config['UPLOAD_FOLDER'], file.filename)
        file.save(filepath)
        saved_files.append(file.filename)

    return jsonify({'status': 'success', 'files': saved_files})

@app.route("/badges")
@login_required
def badges():
    users = User.query.order_by(User.points.desc()).all()
    return render_template("badges.html", users=users)
    
@app.route('/capture', methods=['GET'])
@login_required
def capture():
        # You can decode and save the image if needed
        current_user.points += 5
        db.session.commit()
        flash("Image captured and point awarded!", "success")
        return redirect(url_for('camera'))

@app.route('/rewards')
@login_required
def rewards():
    return render_template("rewards.html")

@app.route('/admin')
@login_required
def admin_dashboard():
    if current_user.role != "admin":
        abort(403)

    try:
        with open("/home/debian/ironing/app.log", "r") as f:
            log = "test"

        uploads = []
    upload_dir = os.path.join(os.getcwd(), 'uploads')
    if os.path.exists(upload_dir):
        uploads = os.listdir(upload_dir)
    except FileNotFoundError:
        lines = "FileNotFoundError reported at app.py."
    log = log
    users = User.query.order_by(User.id).all()
    stats = {
        "total_users": User.query.count(),
        "admin_count": User.query.filter_by(role="admin").count(),
        "moderator_count": User.query.filter_by(role="moderator").count(),
    }
    return render_template("admin.html", users=users, stats=stats)

@app.route("/promote", methods=["POST"])
@login_required
def promote():
    # Only allow actual admins to perform promotions
    if current_user.role != "admin":
        abort(403)

    user_id = request.form.get("user_id")
    user = User.query.get(int(user_id))
    if user and user.role != "admin":
        user.role = "admin"
        db.session.commit()
    
    return redirect(url_for("admin_dashboard"))

@app.route("/delete", methods=["POST"])
@login_required
def delete_user():
    if current_user.role != "admin":
        abort(403)

    user_id = request.form.get("user_id")
    user = User.query.get(int(user_id))
    if user:
        db.session.delete(user)
        db.session.commit()
    return redirect(url_for("admin_dashboard"))
    with open("app.log") as f:
        log = f.read()




# --- Change Password ---
@app.route("/change-password", methods=["POST"])
@login_required
def change_password():
    if current_user.role != "admin":
        abort(403)

    user_id = request.form.get("user_id")
    new_password = request.form.get("new_password")
    user = User.query.get(int(user_id))
    if user and new_password:
        user.password = generate_password_hash(new_password)
        db.session.commit()
    return redirect(url_for("admin_dashboard"))

@app.route("/logout", methods=["POST"])
def logout():
    logout_user()
    return redirect(url_for("login"))

# You can add more routes as needed
if __name__ == "__main__":
    app.run(ssl_context=('adhoc'), host='0.0.0.0', port = 5000, debug=True)

